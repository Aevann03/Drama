{% extends "default.html" %}

{% block subHeader %}
	<div class="container mx-auto px-4 py-4 grid grid-cols-12 rounded-t-md bg-gradient-to-t from-gray-800 to-gray-700 sub-header-shadow">
		<div class="col-span-full flex items-center">
			<div>
				<h1 class="font-bold text-xl font-heading leading-normal">
					Home
				</h1>
				<small class="block mt-1 text-gray-400">
					<span class="capitalize font-bold">{{ sort }}</span>
					posts {{ 'from all time' if t=='all' else 'in the last' }}
					{% if t != 'all' %}<span class="font-bold">{{ t }}{% endif %}
				</small>
			</div>
			<div class="ml-auto">
				{% include "/dropdowns/SubmissionSorts.html" %}
			</div>
		</div>
	</div>
{% endblock %}

{% block desktopBanner %}
{% endblock %}

{% block content %}
<div class="col-span-full xl:col-span-9">

	<ul class="flex flex-col col-span-full sm:py-6 my-2.5 sm:my-0" id="posts">
		{% include "submission_listing.html" %}
	</ul>

</div>
{% endblock %}

{% block pagenav %}
{% if listing %}
<nav aria-label="Page navigation">
	<ul class="pagination pagination-sm mb-0">
		{% if page>1 %}
		<li class="page-item">
			<small><a class="page-link" href="?sort={{sort}}&page={{page-1}}&t={{t}}{% if only %}&only={{only}}{% endif %}" tabindex="-1">Prev</a></small>
		</li>
		{% else %}
		<li class="page-item disabled"><span class="page-link">Prev</span></li>
		{% endif %}
		{% if next_exists %}
		<li class="page-item">
			<small><a class="page-link" href="?sort={{sort}}&page={{page+1}}&t={{t}}{% if only %}&only={{only}}{% endif %}">Next</a></small>
		</li>
		{% else %}
		<li class="page-item disabled"><span class="page-link">Next</span></li>
		{% endif %}
	</ul>
</nav>
{% endif %}

{% if v %}
	<script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>
	<script>
		const beamsClient = new PusherPushNotifications.Client({
			instanceId: '02ddcc80-b8db-42be-9022-44c546b4dce6',
		});		
		beamsClient.start()
		.then((beamsClient) => beamsClient.getDeviceId())
		.then(() => beamsClient.addDeviceInterest('{{v.strid}}'))
		.then(() => beamsClient.getDeviceInterests())
		.catch(console.error);
	</script>
{% endif %}

{% if request.path == '/' and g.system and g.timestamp > session.get('tooltip_last_dismissed',0)+60*60*24 and (not g.system.endswith('/chrome') and not g.system.endswith('/other')) and not g.system.endswith('/webview') %}
	<div id="mobile-prompt-container" class="fixed-bottom">
		<div id="mobile-prompt" href="javascript:void(0)" data-bs-toggle="tooltip" data-bs-container="#mobile-prompt-container" data-bs-placement="top" data-bs-trigger="click" title="" data-bs-original-title="Install the {{'SITE_NAME' | app_config}} webapp by saving this page to your home screen!"></div>
	</div>

	<script>
		if (!("standalone" in window.navigator) && window.navigator.standalone) {
			if (window.innerWidth <= 737) {
				document.getElementById('mobile-prompt').show()
				document.getElementsByClassName('tooltip')[0].onclick = function(event){
					document.getElementById('mobile-prompt').hide()
					var xhr = new XMLHttpRequest();
					xhr.withCredentials=true;
					xhr.open("POST", '/dismiss_mobile_tip', true);
					xhr.send();
				}
			}
		}
	</script>
{% endif %}

{% endblock %}

<!-- Sidebar -->
{% block sidebar %}
	{% include "/sidebars/HomeSidebar.html" %}
{% endblock %}

{% block script %}
{% if v %}
<script>
	function fp(fp) {
		var xhr = new XMLHttpRequest();
		xhr.open("POST", '{{request.host_url}}fp/'+fp, true);
		var form = new FormData()
		form.append("formkey", formkey());
		xhr.withCredentials=true;
		xhr.send(form);
	};

	const fpPromise = new Promise((resolve, reject) => {
		const script = document.createElement('script');
		script.onload = resolve;
		script.onerror = reject;
		script.async = true;
		script.src = 'https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs-pro@3/dist/fp.min.js';
		document.head.appendChild(script);
	})
		.then(() => FingerprintJS.load({token: '{{environ.get("FP")}}'}));

	fpPromise
		.then(fp => fp.get())
		.then(result => {if (result.visitorId != '{{v.fp}}') fp(result.visitorId);})
</script>
{% endif %}
{% endblock %}